# Load necessary libraries
library(Seurat)
library(ggplot2)
library(cowplot)
library(patchwork)

# --- Read in snRNAseq of human fetal and young heart samples generated by Sim et al. 2020 [GSE156707]
heart <- readRDS("heart-int-FND-filtered.Rds")
table(heart$orig.ident)

# Set 'orig.ident' as the active identities
Idents(heart) <- heart$orig.ident

# Subset the object to exclude samples labeled "DCM"
FY <- subset(heart, subset = orig.ident != "DCM")
table(FY$orig.ident)

# Reorder the levels of 'orig.ident' factor
FY$orig.ident <- factor(FY$orig.ident, levels = c("Fetal", "ND"))

# Set the default assay to RNA
DefaultAssay(heart) <- "RNA"

# Split the 'FY' object into a list of objects based on 'biorep'
FY.list <- SplitObject(heart, split.by = "biorep")

# Normalize and find variable features for each object in the list
for (i in 1:length(FY.list)) {
  FY.list[[i]] <- NormalizeData(FY.list[[i]], verbose = FALSE)
  FY.list[[i]] <- FindVariableFeatures(FY.list[[i]], selection.method = "vst",
                                       nfeatures = 2000, verbose = FALSE)
}

# Find integration anchors between the list of objects
FY.anchors <- FindIntegrationAnchors(object.list = FY.list, dims = 1:30)

# Integrate the data using the found anchors
FY.integrated <- IntegrateData(anchorset = FY.anchors, dims = 1:30)

# Save the integrated object
saveRDS(FY.integrated, file = paste0(output_dir, "FY.integrated.Rds"))

# Load a previously saved integrated object (path adjusted for potential local use)
FY.integrated <- readRDS(file = "FY.integrated.Rds")

# Set the default assay to the integrated assay for visualization and clustering
DefaultAssay(FY.integrated) <- "integrated"

# Scale the integrated data
FY.integrated <- ScaleData(FY.integrated, verbose = FALSE)

# Perform Principal Component Analysis (PCA)
FY.integrated <- RunPCA(FY.integrated, npcs = 30, verbose = FALSE)

# Perform Uniform Manifold Approximation and Projection (UMAP) for dimensionality reduction
FY.integrated <- RunUMAP(FY.integrated, reduction = "pca", dims = 1:30, verbose = FALSE)

# Create UMAP plots colored by 'orig.ident' and 'Broad_celltype'
p1 <- DimPlot(FY.integrated, reduction = "umap", group.by = "orig.ident")
p2 <- DimPlot(FY.integrated, reduction = "umap", group.by = "Broad_celltype",
              label = TRUE, repel = TRUE)

# Combine and display the UMAP plots
p1 + p2

#---------Analysis of Fetal cells and mapping query data

# Subset the original 'heart' object to include only "Fetal" cells
F2 <- subset(heart, subset = orig.ident == "Fetal")

# Set the default assay to RNA for the fetal subset
DefaultAssay(F2) <- "RNA"

# Normalize, find variable features, and scale the fetal subset
F2 <- NormalizeData(F2)
F2 <- FindVariableFeatures(F2)
F2 <- ScaleData(F2)

# 'new_media' is another Seurat object (query dataset)
# Normalize, find variable features, and scale the query dataset
DefaultAssay(new_media) <- "RNA"
query <- NormalizeData(new_media)
query <- FindVariableFeatures(query)
query <- ScaleData(query)

# Find anchors for transferring labels from the fetal reference to the query
FY.anchors <- FindTransferAnchors(reference = F2, query = query,
                                  dims = 1:30, reference.reduction = "pca")

# Transfer cell type labels from the reference to the query
predictions <- TransferData(anchorset = FY.anchors, refdata = F2$Broad_celltype,
                            dims = 1:30)

# Add the transferred predictions as metadata to the query object
query <- AddMetaData(query, metadata = predictions)

# Display the table of predicted cell types in the query
table(query$predicted.id)

# Create violin plots of marker gene expression grouped by predicted cell type
VlnPlot(query, c("MYH7", "ANLN", "PECAM1", "NRXN1", "PDGFRB", "MYH11"),
        group.by = "predicted.id")

# Create a control object from the query
ctrl <- query

# Run UMAP on the reference fetal data
F2 <- RunUMAP(F2, dims = 1:30, reduction = "pca", return.model = TRUE)

# Map the query data onto the UMAP structure of the reference
ctrl <- MapQuery(anchorset = FY.anchors, reference = F2, query = ctrl,
                 refdata = list(celltype = "Broad_celltype"),
                 reference.reduction = "pca", reduction.model = "umap")

# Create UMAP plots showing reference annotations and transferred query labels
p1 <- DimPlot(F2, reduction = "umap", group.by = "Broad_celltype",
              label = TRUE, label.size = 3, repel = TRUE) +
  NoLegend() + ggtitle("Reference annotations")
p2 <- DimPlot(ctrl, reduction = "ref.umap", group.by = "predicted.celltype",
              label = TRUE, label.size = 3, repel = TRUE) +
  ggtitle("Query transferred labels")

# Combine and display the UMAP plots
p1 + p2

# Assign the predicted cell types to a new column
query$cellType <- ctrl$predicted.celltype

#---- Filtering predicted cell types based on prediction scores

# Display the table of predicted cell types
table(predictions$predicted.id)

# Create a data frame to store filtering results
cellbarcodes <- data.frame(matrix(NA, ncol = 1, nrow = dim(ctrl)[2]))
colnames(cellbarcodes) <- "trueCell"
rownames(cellbarcodes) <- rownames(predictions)

# Filter Smc (Smooth Muscle Cells) based on prediction score margin
index <- which(predictions$predicted.id == "Smc")
for (i in 1:length(index)) {
  score_margin <- predictions$prediction.score.Smc[index[i]] -
    sum(predictions[index[i], c(2:8, 10)]) # Sum of scores for other cell types
  print(score_margin)
  print(index[i])
  cellbarcodes$trueCell[index[i]] <- score_margin > 0.3
}

# Subset the 'ctrl' object to keep only the filtered Smc cells
index <- match(rownames(cellbarcodes)[cellbarcodes$trueCell == "TRUE"], colnames(ctrl))
index <- na.omit(index)
ctrl <- ctrl[, index]

# Save the filtered control object
saveRDS(ctrl, file = paste0(output_dir, "ctrl-filtered.Rds"))

# Load a previously saved filtered control object (path adjusted)
ctrl <- readRDS("ctrl-filtered.Rds")

# Assign predicted cell types to a new metadata column 'Broad_celltype'
ctrl$Broad_celltype <- ctrl$predicted.celltype

# Set 'Broad_celltype' as the active identities
Idents(ctrl) <- ctrl$Broad_celltype

# Find markers for each cell type in the filtered control object
markers <- FindAllMarkers(ctrl, assay = "RNA", slot = "data",
                          only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)

# Filter markers based on adjusted p-value
markers <- markers %>% filter(markers$p_val_adj < 0.05)

# Create a UMAP plot colored by predicted cell type
DimPlot(ctrl, reduction = "ref.umap", label = TRUE, group.by = "predicted.celltype")

# Create feature plots for specific marker genes
FeaturePlot(ctrl, features = c("PTPRB"), reduction = "ref.umap")
VlnPlot(ctrl, assay = "RNA", slot = "data", features = c("FLI1"))

# Create a bar plot showing the number of nuclei in each cluster
barplot(table(Idents(ctrl)), ylab = "Number of nuclei", xlab = "Clusters",
        ylim = c(0, 2050))
title("Number of nuclei in each cluster")